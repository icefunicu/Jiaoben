# Terminology Sidebar Extension

智能术语侧边栏扩展，利用高性能算法在浏览网页时自动识别、高亮并解释专业术语。

## 主要特性

- **高性能匹配**：采用 AC 自动机 (Aho-Corasick) 算法 + Web Worker 多线程架构，实现毫秒级海量术语匹配，不阻塞主线程。
- **无侵入渲染**：集成 CSS Custom Highlight API，性能远超传统 DOM 替换方案，大幅降低内存占用与重排。
- **现代化 UI**：
  - **虚拟列表**：支持流畅展示数千条术语。
  - **详情阅读态**：点击术语进入抽屉式详情，正文滚动阅读与复制完整详情。
  - **暗色模式**：完美适配系统主题。
- **多语言支持**：内置中英文词库，支持 Wiki/Wiktionary 在线百科实时查询。

## 外部请求清单

- `https://*.wiktionary.org/*`：术语释义与示例获取；触发条件为详情字段缺失或手动刷新；失败策略为保留本地词库内容并继续展示来源区块；可通过设置关闭联网功能。
- `https://*.wikipedia.org/*`：术语概述补全；触发条件为详情字段缺失或手动刷新；失败策略为保留本地词库内容并继续展示来源区块；可通过设置关闭联网功能。

## 开发指南

1. **构建项目**：
   修改 `src` 目录下的源代码后，运行打包脚本：
   ```bash
   node tools/bundle.js
   ```

2. **重建词库详情**：
   需要更新本地词库详情时，执行构建脚本：
   ```bash
   python tools/build_glossary.py
   ```

3. **安装扩展**：
   - 打开 Chrome 扩展管理页 `chrome://extensions`
   - 开启“开发者模式”
   - 点击“加载已解压的扩展程序”，选择 `extensions/terminology-sidebar` 目录。

## 快捷键

- `Alt + T`: 快速切换侧边栏显示/隐藏。

## 更新日志 (Changelog)

### 2026-02-04 详情信息补全与重建
- **详情兜底增强**：详情面板在缺少扩展字段时，自动回退到本地定义与示例，并触发联网补全，确保展示内容完整可读。
- **联网默认开启**：联网补全开关默认开启，优先保证详情完整性。
- **构建数据扩展**：词库构建加入领域补充数据与更长解释字段，为详情面板提供更具体的信息来源。

### 2026-02-04 首次加载引导与快捷键容错
- **首次加载引导**：扩展首次注入页面时自动打开侧边栏并展示教程弹窗，完成后不再重复出现。
- **快捷键容错**：在不支持注入的页面触发快捷键时不再抛出连接错误。

### 2026-02-04 首次使用引导
- **弹窗教程**：首次安装/首次使用会展示快速上手弹窗，完成后不再显示。

### 2026-02-04 性能与体验优化
- **动画引擎重构**：全线引入 GPU 加速 (`translate3d`, `will-change`) 与定制贝塞尔曲线 (`cubic-bezier`)，确保侧边栏进出、列表 Hover、Resize 拖拽达到 60FPS 满帧流畅度。
- **虚拟滚动修复**：修复了虚拟列表在 `sidebar/index.js` 中的集成逻辑，确保在大数据量下滚动依旧丝滑。
- **交互细节打磨**：
  - **Resize 节流**：使用 `requestAnimationFrame` 优化侧边栏宽度拖拽逻辑，消除掉帧感。
  - **微交互**：优化滚动条样式与 Hover 反馈，增强列表项的位移感。
  - **视觉反馈**：优化骨架屏动画曲线，使其更具呼吸感。

### 2026-02-04 深度性能优化
- **扫描效率提升**：重写 DOM 扫描逻辑，使用 `checkVisibility` API 与递归遍历替代 `TreeWalker` + `getComputedStyle`，在复杂页面上的扫描速度提升显著，并大幅减少重排。
- **匹配引擎升级**：优化 Web Worker 中的 AC 自动机实现，使用 `Map` 数据结构优化节点查找，减少内存占用并提升匹配吞吐量。
- **渲染性能微调**：优化侧边栏虚拟列表渲染机制，复用 DOM 容器节点，减少滚动时的 DOM 操作开销。

### 2026-02-04 极致性能与UI/UX增强
- **极致性能**：
  - **Web Worker 异步匹配**：将 AC 自动机（Aho-Corasick）匹配逻辑完全迁移至后台 Web Worker 线程 (`worker.js`)，彻底消除主线程阻塞，保证页面交互零卡顿。
  - **CSS Custom Highlight API**：集成原生 Highlight API (`CSS.highlights`) 实现高性能文本高亮，替代传统的 DOM 节点包裹方案，大幅降低 DOM 操作开销（支持回退兼容）。
- **极致 UI/UX**：
  - **Toast 通知系统**：新增非侵入式 Toast 通知组件，提供复制成功等操作的即时反馈。
  - **骨架屏加载 (Skeleton)**：为联网查询等异步操作添加骨架屏加载动画，提升视觉流畅度与加载感知。
  - **动画与过渡**：全面优化侧边栏展开/收起、列表项交互、面板切换的过渡动画 (`transition`/`keyframes`)，体验丝般顺滑。

### 2026-02-04 架构重构与增强
- **架构重构**：
  - 引入 `Store` 模式（响应式状态管理），替代了原有的全局 `STATE` 对象，实现了状态与 UI 的解耦。
  - 重构了 `scanner.js`, `sidebar-manager.js`, `settings.js` 等核心模块以适配新的状态管理方案。
- **UI 性能增强**：
  - 实现了 **虚拟列表 (Virtual List)** 渲染机制，支持在侧边栏流畅展示成千上万个术语，移除了原有的列表长度限制（`listLimit` 现仅作为扫描上限参考）。
  - 优化了列表滚动体验和内存占用。
- **工程化**：
  - 为核心模块添加了 JSDoc 类型注释，增强代码可读性与维护性。

### 2026-02-04 性能与稳定性优化
- **数据加载**：`glossary.js` 优化为使用 `Promise.allSettled` 并行加载中英文词库，增加容错机制，避免单语言加载失败导致整个插件失效。
- **扫描性能**：优化 `scanner.js` 内存使用，移除冗余的对象创建与字符串处理，降低扫描时的内存峰值。
- **UI 改进**：
  - 优化滚动条样式，使其更加美观且支持悬停交互。
  - 改进按钮交互状态反馈。
  - 增强暗色模式下的视觉体验。

### 2026-02-04 交互与稳定性修复 (Fixes & Enhancements)
- **稳定性修复**：修复了 Web Worker 初始化时的竞态条件（Race Condition），解决了部分情况下 contentScript 报错导致无法扫描的问题。
- **交互增强**：
  - **点击跳转**：现在点击侧边栏术语时，页面会自动滚动至第一个匹配项并高亮显示。
  - **列表去重**：实现了侧边栏列表的忽略大小写去重（Case-insensitive Deduplication），避免同一术语因大小写不同而重复显示。
  - **内联详情**：点击术语后，详情面板会在列表项内部直接展开（手风琴效果），无需再滚动至侧边栏底部查看。
- **扫描优化**：
  - **正文识别**：实现了基于启发式算法的正文区域识别（优先扫描 `article`, `main` 等标签），并自动排除导航、页脚、广告等非正文区域，提高扫描精度。
  - **Rescan 修复**：修复了在极端情况下重新扫描可能无响应的问题。
- **UI/UX 升级**：
  - **视觉美化**：采用了更现代的卡片式设计，优化了字体排版与间距，引入了高质量 SVG 图标。
  - **防抖优化**：重写了虚拟列表渲染逻辑，解决了列表项展开时的滚动抖动（Jitter）问题。
  - **信息增强**：详情页现在会显示完整的定义、所有示例（而不仅是前两个），并增加了醒目的领域标签（Domain Badge）。

### 2026-02-04 详情页视觉升级与滚动修复
- **视觉重构**：重设计详情页 UI，移除多余嵌套，显著提升定义文字的可读性与层级感。
- **滚动防抖 2.0**：通过 CSS 动画状态管理，彻底修复了虚拟列表滚动时详情页意外收缩/展开的视觉抖动问题。
