<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>书签整理器</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="popup">
  <header>
    <h1>书签整理器</h1>
    <p>按关键词或 AI 智能归类书签</p>
  </header>

  <!-- 标签页切换 -->
  <div class="tabs">
    <button class="tab active" data-tab="organize">整理</button>
    <button class="tab" data-tab="preview">预览</button>
    <button class="tab" data-tab="tools">工具</button>
  </div>

  <!-- 整理面板 -->
  <section id="organizePanel" class="card tab-content active">
    <div class="mode-selector">
      <label class="mode-option">
        <input type="radio" name="classifyMode" value="keyword" checked />
        <span class="mode-label">
          <span class="mode-title">关键词模式</span>
          <span class="mode-desc">使用预设关键词规则匹配</span>
        </span>
      </label>
      <label class="mode-option">
        <input type="radio" name="classifyMode" value="ai" />
        <span class="mode-label">
          <span class="mode-title">AI 智能模式</span>
          <span class="mode-desc">使用 AI 自动分析分类</span>
        </span>
      </label>
      <label class="mode-option">
        <input type="radio" name="classifyMode" value="hybrid" />
        <span class="mode-label">
          <span class="mode-title">混合模式</span>
          <span class="mode-desc">关键词优先，未匹配用 AI</span>
        </span>
      </label>
    </div>

    <div id="aiWarning" class="warning" style="display: none;">
      <svg class="warning-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
        <path d="M12 9v4" />
        <path d="M12 17h.01" />
      </svg>
      <span>请先在设置页配置 AI API 密钥</span>
    </div>

    <div class="checkbox-group">
      <label class="checkbox">
        <input type="checkbox" id="dryRun" />
        预演模式（不移动书签）
      </label>
      <label class="checkbox">
        <input type="checkbox" id="incrementalOnly" />
        仅处理新书签
      </label>
      <label class="checkbox">
        <input type="checkbox" id="groupByDomain" checked />
        同域名自动建组 (≥3个)
      </label>
    </div>

    <p id="targetHint" class="hint"></p>

    <div id="progressContainer" class="progress-container" style="display: none;">
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <p id="progressText" class="progress-text">准备中...</p>
    </div>

    <div class="button-row">
      <button id="run" class="primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 3v12" />
          <path d="m8 11 4 4 4-4" />
          <path d="M8 5H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-4" />
        </svg>
        开始整理
      </button>
      <button id="undo" class="secondary" title="撤销上次整理" disabled>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 7v6h6" />
          <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" />
        </svg>
      </button>
    </div>

    <p id="status" class="status"></p>

    <!-- 可视化图表 -->
    <div id="chartContainer" class="chart-container" style="display: none;">
      <h3 class="chart-title">分类统计</h3>
      <svg id="pieChart" class="pie-chart" viewBox="0 0 200 200"></svg>
      <div id="chartLegend" class="chart-legend"></div>
    </div>
  </section>

  <!-- 预览面板 -->
  <section id="previewPanel" class="card tab-content" style="display: none;">
    <div class="preview-header">
      <h3>书签预览</h3>
      <button id="refreshPreview" class="ghost">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
          <path d="M21 3v5h-5" />
        </svg>
        刷新
      </button>
    </div>
    <p class="hint" id="previewHint">点击刷新按钮加载预览数据</p>

    <div id="previewStats" class="preview-stats" style="display: none;">
      <span class="stat-item"><span class="stat-label">总计:</span> <span id="previewTotal">0</span></span>
      <span class="stat-item matched"><span class="stat-label">已匹配:</span> <span id="previewMatched">0</span></span>
      <span class="stat-item unmatched"><span class="stat-label">未匹配:</span> <span id="previewUnmatched">0</span></span>
    </div>

    <div class="search-container">
      <input type="text" id="searchInput" placeholder="搜索书签..." class="search-input">
    </div>
    <div id="previewList" class="preview-list"></div>
  </section>

  <!-- 工具面板 -->
  <section id="toolsPanel" class="card tab-content" style="display: none;">
    <div class="tool-section">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
          <path d="M16 3.13a4 4 0 0 1 0 7.75" />
        </svg>
        重复书签检测
      </h3>
      <p class="hint">查找并合并重复的书签</p>
      <div style="margin-bottom: 8px;">
        <label class="checkbox">
          <input type="checkbox" id="fuzzyDuplicate" />
          深度模糊匹配 (忽略参数差异)
        </label>
      </div>
      <button id="findDuplicates" class="secondary">检测重复</button>
      <div id="duplicatesResult" class="duplicates-result" style="display: none;">
        <p id="duplicatesCount"></p>
        <div id="duplicatesList" class="duplicates-list"></div>
        <button id="mergeDuplicates" class="remove" style="display: none;">合并全部（保留最早添加的）</button>
      </div>
    </div>

    <div class="tool-section">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
        </svg>
        失效链接清理
      </h3>
      <p class="hint">检测并移除无法访问的书签</p>
      <button id="scanDeadLinks" class="secondary">开始检测</button>
      <div id="deadLinksResult" class="duplicates-result" style="display: none;">
        <p id="deadLinksCount"></p>
        <ul id="deadLinksList"></ul>
        <button id="removeDeadLinks" class="primary small-btn">移除选中链接</button>
      </div>
    </div>

    <div class="tool-section">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
        文件夹整理
      </h3>
      <p class="hint">合并相似名称的文件夹 (如 "Dev" 和 "Development")</p>
      <div class="row">
        <button id="scanFolders" class="secondary">扫描相似文件夹</button>
        <button id="cleanEmptyFolders" class="secondary" title="清理所有空文件夹">清理空文件夹</button>
      </div>
      <div id="mergeFoldersResult" style="display: none;">
        <div id="mergeSuggestions"></div>
      </div>
    </div>

    <div class="tool-section">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
        操作历史
      </h3>
      <p class="hint">查看最近的整理记录</p>
      <div id="historyList" class="history-list"></div>
    </div>

    <div class="tool-section">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
        缓存管理
      </h3>
      <p class="hint">AI 分类结果会被缓存以提升性能</p>
      <button id="clearCache" class="ghost">清除 AI 缓存</button>
    </div>
  </section>

  <footer>
    <a id="openOptions" href="options.html" target="_blank">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;">
        <path
          d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
        <circle cx="12" cy="12" r="3" />
      </svg>
      编辑规则与设置
    </a>
    <span class="shortcut-hint">快捷键: Ctrl+Shift+B</span>
  </footer>

  <script type="module" src="popup.js"></script>
</body>

</html>